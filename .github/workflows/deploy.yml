  name: Deploy Portfolio

  on:
    push:
      branches:
        - main  # trigger on pushes to main branch

  jobs:
    deploy:
      runs-on: ubuntu-latest

      steps:
        # Step 1: Checkout the repository
        - name: Checkout repo
          uses: actions/checkout@v3

        # Step 2: Setup Node.js
        - name: Setup Node.js
          uses: actions/setup-node@v3
          with:
            node-version: '20'

        # Step 3: Install dependencies locally (on Actions runner)
        - name: Install dependencies
          run: npm ci

        # Step 4: Build the project locally (on Actions runner)
        - name: Build project
          run: npm run build

        # Step 5: Test SSH connection
        - name: Test SSH connection
          uses: appleboy/ssh-action@v0.1.9
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.SERVER_KEY }}
            port: 22
            script: |
              echo "SSH connection successful!"
              whoami
              pwd

        # Step 6: Deploy to VPS
        - name: Deploy to VPS
          uses: appleboy/ssh-action@v0.1.9
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.SERVER_KEY }}
            port: 8022
            script: |
              echo "Starting deployment..."
              cd /home/nabin/Nabin-Thapa || exit 1
              echo "Pulling latest code..."
              git reset --hard
              git clean -fd
              git pull origin main
              echo "Installing dependencies..."
              npm ci
              echo "Building project..."
              npm run build
              echo "Restarting PM2 process..."
              pm2 restart portfolio || pm2 start npm --name portfolio -- run start
              echo "Deployment finished successfully!"
